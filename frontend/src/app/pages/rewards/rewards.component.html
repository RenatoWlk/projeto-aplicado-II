<div class="rewards-page-container">

  <section class="app-card">
    <div class="app-card-header">
      <i class="fa-solid fa-gift app-card-icon"></i>
      <h2 class="app-card-title">Recompensas</h2>
    </div>

    <div class="rewards-top">
      <div class="points-summary">
        <p class="points-label">Seus pontos</p>
        <p class="points-value">{{ formatPoints(userPoints) }}</p>
      </div>

      <div class="controls">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input class="search-input" type="text" placeholder="Buscar recompensas..." [(ngModel)]="query" />
        </div>
        
        <div class="filter-buttons">
          <button type="button" [class.active]="filter==='all'" (click)="filter='all'">Todas</button>
          <button type="button" [class.active]="filter==='canRedeem'" (click)="filter='canRedeem'">Posso resgatar</button>
          <button type="button" [class.active]="filter==='available'" (click)="filter='available'">Disponíveis</button>
          <button type="button" [class.active]="filter==='redeemed'" (click)="filter='redeemed'">Resgatadas</button>
        </div>
      </div>
    </div>

    <div class="cards-grid-medium-low cards-grid-overflow-large">
      <article class="card reward-card" *ngFor="let reward of visibleRewards">
        <header class="card-header">
          <div class="reward-header-left">
            <div class="reward-meta">
              <h3 class="card-title">{{ reward.partnerName }}: {{ reward.title }}</h3>
              <p class="card-subtitle">{{ reward.description }}</p>
            </div>
          </div>

          <div class="reward-actions">
            <p class="required-points">{{ reward.requiredPoints | number:'1.0-0' }} pontos para resgatar</p>
            <p class="stock" *ngIf="reward.stock > 0">{{ reward.stock }} restantes</p>
            <p class="stock out" *ngIf="reward.stock === 0">Esgotado</p>

            <button
              class="app-button"
              [ngClass]="{
                'redeem-available': canRedeem(reward) && !reward.redeemed && reward.stock > 0,
                'redeem-blocked': !canRedeem(reward) && !reward.redeemed && reward.stock > 0,
                'redeemed': reward.redeemed,
                'out-of-stock': reward.stock === 0
              }"
              [disabled]="reward.stock === 0 || (!canRedeem(reward) && !reward.redeemed)"
              (click)="openRedeemModal(reward)"
            >
              {{ reward.redeemed ? 'Resgatado' : reward.stock === 0 ? 'Esgotado' : canRedeem(reward) ? 'Resgatar' : 'Pontos insuficientes'
              }}
            </button>
          </div>
        </header>
      </article>

      <div *ngIf="visibleRewards.length === 0" class="card">
        <p class="card-body">Nenhum resultado encontrado.</p>
      </div>
    </div>
  </section>

  <div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()"></div>
  <div class="modal" *ngIf="isModalOpen" role="dialog" aria-modal="true" aria-labelledby="redeemTitle">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3 id="redeemTitle">{{ selectedReward?.title }}</h3>
      <p class="modal-partner">{{ selectedReward?.partnerName }}</p>
      <p class="modal-desc">{{ selectedReward?.description }}</p>
      <p class="modal-required">{{ selectedReward?.requiredPoints }} pontos necessários</p>

      <div class="modal-actions">
        <button class="app-button" (click)="confirmRedeem()" [disabled]="!selectedReward || !canRedeem(selectedReward)">
          Confirmar resgate
        </button>
        <button class="app-button" (click)="closeModal()" style="background-color: white; color: #c62828; border: 2px solid #c62828;">
          Cancelar
        </button>
      </div>
    </div>
  </div>

</div>
