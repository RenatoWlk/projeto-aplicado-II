<div class="calendar-layout">
    <div class="app-card schedule-card">

        <!-- Loading state -->
        <ng-container *ngIf="isLoadingAppointment">
            <app-preloader type="spinner" [visible]="true"></app-preloader>
        </ng-container>

        <!-- User did not answer the questionnaire -->
        <ng-container *ngIf="!isLoadingAppointment && canSchedule === null">
            <div class="eligibility-warning-schedule">
                <i class="fa-solid fa-exclamation-triangle icon-warning-eligible"></i>
                <h3 class="section-title">Responda o questionário de elegibilidade!</h3>
                
                <p class="warning-eligible-info">
                    (Você poderá realizar um agendamento após responder)
                </p>
                <a class="warning-eligible-route" routerLink="/questionario">Ir para o questionário</a>
            </div>
        </ng-container>

        <!-- User not eligible to donate -->
        <ng-container *ngIf="!isLoadingAppointment && canSchedule === false">
            <div class="not-eligible-to-schedule">
                <i class="fa-solid fa-exclamation-circle icon-not-eligible"></i>
                <h3 class="section-title">Você não está apto para doar no momento!</h3>
                <p class="not-eligible-info">
                    Algumas das suas respostas indicam que você não está apto para doação no momento. 
                    Consulte um profissional de saúde para mais informações.
                </p>
            </div>
        </ng-container>

        <!-- User has active appointment -->
        <ng-container *ngIf="!isLoadingAppointment && canSchedule === true && activeAppointment">
            <h3 class="section-title">Verifique seu agendamento!</h3>

            <div class="appointment-details">
                <div class="detail-row">
                    <span class="label">Data:</span>
                    <span class="value">{{ activeAppointment.date }}</span>
                </div>

                <div class="detail-row">
                    <span class="label">Horário:</span>
                    <span class="value">{{ activeAppointment.hour }}</span>
                </div>

                <div class="detail-row">
                    <span class="label">Banco de Sangue:</span>
                    <span class="value text-break">{{ activeAppointment.bloodBankName }}</span>
                </div>

                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value" [ngClass]="getStatusClass(activeAppointment.status)">
                        {{ activeAppointment.status }}
                    </span>
                </div>
            </div>
            <p class="info-message">
                Você poderá realizar um novo agendamento após este ser cancelado ou completado.
            </p>
            <div class="info-message contact-box">
                <p>Em caso de dúvidas, entre em contato com o banco de sangue:</p>
                <p>
                    Telefone: <strong>{{ activeAppointment.bloodBankTelephone }}</strong><br>
                    Email: <strong>{{ activeAppointment.bloodBankEmail }}</strong>
                </p>
            </div>
            <button class="cancel-date-btn" (click)="cancelDonation()" title="Cancelar pré-agendamento">
                <i class="fa-solid fa-trash"></i>
                Cancelar Pré-agendamento
            </button>
        </ng-container>

        <!-- User donate recently -->
        <div *ngIf="!isLoadingAppointment && canSchedule === true && !activeAppointment && canDonateAgain === false" 
             class="rest-period-notice">
            <i class="fa-solid fa-clock"></i>
            <h3>Período de Descanso</h3>

            <p>Você realizou uma doação recentemente e precisa aguardar o intervalo mínimo.</p>

            <div class="next-donation-info">
                <span class="label">Próxima doação disponível a partir de:</span>
                <span class="value highlight">{{ nextDonationDate }}</span>
            </div>

            <p class="info-message">
                {{ gender === 'Masculino' ? 'Homens devem aguardar 90 dias entre doações.' : 'Mulheres devem aguardar 120 dias entre doações.' }}
            </p>
        </div>

        <!-- Scheduling forms -->
        <div *ngIf="!isLoadingAppointment && canSchedule === true && !activeAppointment && canDonateAgain === true">

            <div class="app-card-header">
                <i class="fa-solid fa-calendar-days app-card-icon"></i>
                <h2 class="app-card-title">Pré-agende sua doação!</h2>
            </div>

            <ul class="app-card-steps">
                <li>Encontre bancos de sangue próximos;</li>
                <li>Verifique a disponibilidade de datas;</li>
                <li>Realize uma reserva de horário;</li>
            </ul>

            <form [formGroup]="scheduleForm" (ngSubmit)="scheduleDonation()" class="schedule-form">

                <!-- Blood bank selector -->
                <mat-form-field appearance="outline" class="custom-form-field select full-width">
                    <mat-label>Selecione o banco de sangue disponível:</mat-label>
                    <mat-select formControlName="availableBloodBanks"
                                (selectionChange)="onSelectBloodBankChange($event.value)">
                        <mat-option *ngFor="let bloodBank of availableBloodBanks" [value]="bloodBank.id">
                            {{ bloodBank.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- Date / time selector -->
                <div *ngIf="selectedBloodBankId" class="date-time-section">

                    <mat-form-field appearance="outline" class="custom-form-field full-width">
                        <mat-label>Data disponível:</mat-label>
                        <input
                            matInput
                            [matDatepicker]="datepicker"
                            formControlName="selectedDate"
                            [matDatepickerFilter]="availableDonationDates"
                            (dateChange)="onDateSelected($event.value)"
                        >
                        <mat-datepicker-toggle matIconSuffix [for]="datepicker"></mat-datepicker-toggle>
                        <mat-datepicker #datepicker [calendarHeaderComponent]="customHeader"></mat-datepicker>
                    </mat-form-field>

                    <mat-form-field *ngIf="availableDonationHours.length > 0"
                                    appearance="outline"
                                    class="custom-form-field select full-width">
                        <mat-label>Horário disponível:</mat-label>
                        <mat-select formControlName="donationTime">
                            <mat-option *ngFor="let slot of availableDonationHours" [value]="slot.time">
                                {{ slot.time }} - {{ slot.availableSpots }} vaga(s)
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Submit -->
                <div class="schedule-button-container">
                    <button type="submit" class="schedule-btn" [disabled]="scheduleForm.invalid">
                        Agendar
                    </button>
                </div>
            </form>
        </div>
    </div> 
</div>